<link rel="import" href="../polymer/polymer.html">
<!-- Iron Elements -->
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../epic-card/epic-card.html">
<link rel="import" href="../epic-styles/epic-styles.html">

<!-- App Elements -->
<link rel="import" href="../app-layout/app-grid/app-grid-style.html">
<!-- <link rel="import" href="../epic-container/epic-container.html"> -->


<dom-module id="epic-video-grid">
    <template>
        <style include="app-grid-style"></style>
        <style include="epic-styles">
            :host {
                --app-grid-columns: 1;
                --app-grid-gutter: calc(var(--epic-baseline)/2);
                display: block;
                background: transparent;
                position: relative;
                box-sizing: border-box;
            }

            @media (min-width: 480px) {
                :host {
                    --app-grid-columns: 2;
                }
            }

            @media (min-width: 840px) {
                :host {
                    --app-grid-gutter: var(--epic-baseline);
                }
            }
            @media (min-width: 1280px) {
                :host {
                    --app-grid-columns: 3;
                }
            }
            @media (min-width: 1440px) {
                :host {
                    --app-grid-columns: 4;
                }
            }
        </style>

        <epic-container contain collapse-padding elevation="0">
        <iron-selector class="app-grid" selected="[[selected]]" selected-item="{{selectedItem}}" selected-class="selected" fallback-selection="0" on-iron-activate="handleIronSelectorActivate">

            <template is="dom-repeat" items="[[videos]]" id="videoList">

             <epic-card placeholder="https://images.contentful.com/1kzutnf7jc3r/3NuGgGWb2ggSo0Ks06QISc/2115b37977a817a28cfb65aed3633c43/ecRidesWithZeal.jpeg?w=1"
                        elevation="1"
                        video="[[item.fields.embedUrl]]"
                        name="[[item.fields.slug]]"
                        heading="[[item.fields.title]]"
                        href="[[item.fields.slug]]"
                        type="video"
                        fade-image
                        preload-image
                        class="item">
                     <div content>[[item.fields.summary]]</div>
                     <div actions>
                       <epic-button expand href="[[item.fields.slug]]" on-tap="handleClick">Watch Now</epic-button>
                     </div>
             </epic-card>

            </template>
        

            </iron-selector>
            </epic-container>
    </template>

    <script>
        /*
          Polymer <epic-video-grid>
          Github: https://github.com/epic-elements/epic-video-grid
          Author: Alex Goodwin (https://github.com/AlexGoodwin)

          NOTE: There is a bug in IE when a user clicks on the SVG play arrow for videos, it doesn't work. This is due to an IE bug where SVG elements don't support element.classList. Since IE usage is so low, I'm leaving this and moving on.

          NOTE: Dynamic Vimeo thumbnails are currently supported. For now, a URL to a blue 480x360px image with "Vimeo" text is returned.

          TODO: fix vimeo thumbnail support
        */
        Polymer({
            is: 'epic-video-grid',

            properties: {
                /**
                  An array of video objects, where each object makes up a card in the video grid
                */
                videos: {
                    type: Array,
                    notify: true,
                    value: function() {
                        return [];
                    }
                },

                selected:{
                    type:String,
                    notify:true,
                    value: ''
                },

                selectedItem:{
                    type:Object,
                    notify:true,
                    observer:'selectedItem()'
                }
            },

            observers: [
                // '_observeVideoChanges(videos)',
                // '_observeSelectedItemChanges(select, videos.*)',
            ],

            handleClick: function(e, detail) {
                this.fire('item-click');
            },

            // _observeSelectedItemChanges: function(select, videoChanges){
            //
            //     if(videoChanges.base.length > 0 && !select){
            //         this.select = videoChanges.base[0].slug;
            //     } else {
            //         this.select = select;
            //     }
            // },

            _computeSelected(selectedItem) {
                if(selectedItem) {
                    return selectedItem.getAttribute('name');
                }
            },

            _hasContent: function(item) {
                        if(item.embedUrl){
                                    return item;
                        }

            },

            /**
              Returns the URL of the thumbnail image to use for the video
              Note vimeo returns a default for now (//placehold.it/480x360/1ab7ea/ffffff/?text=Vimeo)
            */
            getThumbnailUrl: function(embedUrl, videoNumber) {
                if (embedUrl) {

                    var thumbnailUrl = '',
                        videoId = '';

                    if (embedUrl.indexOf('youtube.com') !== -1) {
                        // get [1] in match() array because we want the second captured group (the video id)
                        videoId = embedUrl.match(/(?:.?|)youtube\.com\/(?:embed\/|watch\?v\=)([^\?\v$^]+)/i)[1];
                        thumbnailUrl = '//img.youtube.com/vi/' + videoId + '/hqdefault.jpg';
                        return thumbnailUrl;

                    } else if (embedUrl.indexOf('vimeo.com') !== -1) {

                        /************************

                        There's currently an issue with rendering thumbnail updates for vimeo. Putting this issue on the backburner for now.

                        videoId = embedUrl.match(/(?:.?|)vimeo\.com\/(?:video\/|watch\?v\=)([^\?\v$^]+)/i)[1];

                        var jsonUrl = "http://vimeo.com/api/v2/video/" + videoId + ".json";

                        var xmlhttp = new XMLHttpRequest();
                        xmlhttp.open('GET', jsonUrl, true);
                        xmlhttp.onreadystatechange = (function() {
                            if (xmlhttp.readyState == 4) {
                                if (xmlhttp.status == 200) {
                                    this.videos[videoNumber].thumbnail = JSON.parse(xmlhttp.responseText)[0].thumbnail_large;
                                }
                            }
                        }).bind(this);
                        xmlhttp.send(null);

                        ************************/

                        // return a placeholder for now until proper vimeo support
                        return '//placehold.it/480x360/1ab7ea/ffffff/?text=Vimeo';

                    } else {
                        console.error('video thumbnail generation failed; possibly malformed video url? only youtube and vimeo are currently supported');
                    }

                } else {
                    return '';
                }
            },

            ready: function() {

                this.videos = [
  {
    "sys": {
      "space": {
        "sys": {
          "type": "Link",
          "linkType": "Space",
          "id": "1kzutnf7jc3r"
        }
      },
      "id": "6RYEb6EGrYuaau8i82gwu8",
      "type": "Entry",
      "createdAt": "2016-08-03T01:30:30.187Z",
      "updatedAt": "2016-08-03T06:57:19.709Z",
      "revision": 5,
      "contentType": {
        "sys": {
          "type": "Link",
          "linkType": "ContentType",
          "id": "video"
        }
      },
      "locale": "en-US"
    },
    "fields": {
      "title": "The Road To Woodward - Episode 1",
      "slug": "road-to-woodward-1",
      "summary": "Stoke is heating up in the Colorado high country as fun was shared by all this week at Woodward at Copper.",
      "details": "Stoke is heating up in the Colorado high country as fun was shared by all this week at Woodward at Copper. This summer, our events crew met up with ZEAL riders Mike Sears and Brolin Mawejje at Copper Moutain’s Pipeline Park for some much anticipated summer shred. Watch the gang stick trick after trick and hone their moves outdoors and in with some elevated trampoline time. Rest assured, no pillowcase went un-tie died as the fun continued from sun up to sun down.",
      "embedUrl": "https://www.youtube.com/embed/-Kt2JaYFpVQ",
      "tags": [
        "woodward",
        "snow",
        "snowboarding",
        "events",
        "tahoe",
        "brolin mawejje",
        "mike sears",
        "lake tahoe",
        "summer camp",
        "road trip",
        "ambassadors"
      ]
    }
  },
  {
    "sys": {
      "space": {
        "sys": {
          "type": "Link",
          "linkType": "Space",
          "id": "1kzutnf7jc3r"
        }
      },
      "id": "4vEPT9iFcAoO2OeEQeSaEE",
      "type": "Entry",
      "createdAt": "2016-08-03T11:35:17.161Z",
      "updatedAt": "2016-08-03T11:35:17.161Z",
      "revision": 1,
      "contentType": {
        "sys": {
          "type": "Link",
          "linkType": "ContentType",
          "id": "video"
        }
      },
      "locale": "en-US"
    },
    "fields": {
      "title": "The Road To Woodward - Episode 2",
      "slug": "road-to-woodward-2",
      "summary": "With ZEAL Week at Copper coming to a close, the ZEAL crew hops on the loneliest highway in America due west...",
      "details": "With ZEAL Week at Copper coming to a close, the ZEAL crew hops on the loneliest highway in America due west, but not before experiencing some near misses on the slopes, cold nights under the stars, company of old and new friends and the passion of the next generation. Check out the latest installment of ZEAL Optics Road to Woodward and come explore more with us as we quest west to Tahoe!",
      "embedUrl": "https://www.youtube.com/embed/kbXGgzgVz9g",
      "tags": [
        "woodward",
        "snow",
        "snowboarding",
        "events",
        "tahoe",
        "brolin mawejje",
        "mike sears",
        "lake tahoe",
        "summer camp",
        "road trip",
        "ambassadors"
      ]
    }
  },
  {
    "sys": {
      "space": {
        "sys": {
          "type": "Link",
          "linkType": "Space",
          "id": "1kzutnf7jc3r"
        }
      },
      "id": "1PagCmo1yoO4oSqGkm844q",
      "type": "Entry",
      "createdAt": "2016-08-03T11:41:23.069Z",
      "updatedAt": "2016-08-03T11:41:23.070Z",
      "revision": 1,
      "contentType": {
        "sys": {
          "type": "Link",
          "linkType": "ContentType",
          "id": "video"
        }
      },
      "locale": "en-US"
    },
    "fields": {
      "title": "The Road To Woodward - The Brolin Mawejje Files",
      "slug": "the-road-to-woodward-the-brolin-mawejje-files",
      "summary": "Hit the road with Brolin Mawejje as he chases the stoke from ZEAL Week at Woodward at Copper to the encore mayhem of Woodward Tahoe''s ZEAL Week! ",
      "details ": "Hit the road with Brolin Mawejje as he chases the stoke from ZEAL Week at Woodward at Copper to the encore mayhem of Woodward Tahoe''s ZEAL Week! Brolin followed Zeal Optics weeks @ both Woodward Copper (6/12-6/18) and Woodward Tahoe (6/19-6/25) in search of sunshine, snow and good old fashioned camp fun. Additional Appearances by Josiah Goedecke, Madison Ellsworth, Ryan Riggins, Jamie Normandin and campers.",
      "embedUrl": "https://www.youtube.com/embed/rijK3RDRPXk",
      "tags": [
        "woodward",
        "snow",
        "snowboarding",
        "events",
        "tahoe",
        "brolin mawejje",
        "mike sears",
        "lake tahoe",
        "summer camp",
        "road trip",
        "ambassadors"
      ]
    }
  },
  {
    "sys": {
      "space": {
        "sys": {
          "type": "Link",
          "linkType": "Space",
          "id": "1kzutnf7jc3r"
        }
      },
      "id": "4wDU10hofSwIKsCMiy6KQW",
      "type": "Entry",
      "createdAt": "2016-08-03T11:36:57.146Z",
      "updatedAt": "2016-08-03T11:36:57.146Z",
      "revision": 1,
      "contentType": {
        "sys": {
          "type": "Link",
          "linkType": "ContentType",
          "id": "video"
        }
      },
      "locale": "en-US"
    },
    "fields": {
      "title": "The Road To Woodward - Episode 3",
      "slug": "road-to-woodward-3",
      "summary": "Our intrepid events crew making there way west navigating dauntingly straight roads, deserted ghost towns and the biggest little city in the world they finally arrive at their final destination; Woodward Tahoe.",
      "details": "With our intrepid events crew making there way west navigating dauntingly straight roads, deserted ghost towns and the biggest little city in the world they finally arrive at their final destination; Woodward Tahoe. Utilizing a demonic snow making machine that produces snow at any ambient temperature the ZEAL team didn’t hesitate to throw down. With a day off the snow the crew migrated towards Lake Tahoe to go explore the surroundings and catch some of the favorite local digs. Feeling clean and energized to finish the week off strong we head back to camp and gear up for what the final days hold. Follow along and stay tuned for the last installment of the Road to Woodward. ",
      "embedUrl": "https://www.youtube.com/embed/rhIOtdKYBUE",
      "tags": [
        "woodward",
        "snow",
        "snowboarding",
        "events",
        "tahoe",
        "brolin mawejje",
        "mike sears",
        "lake tahoe",
        "summer camp",
        "road trip",
        "ambassadors"
      ]
    }
  }
];
            },
        });
    </script>
</dom-module>
