<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../epic-card/epic-card.html">

<dom-module id="epic-video-grid">
    <template>
        <style>
            :host {
                display: block;
                background: transparent;
            }

            .header {
                text-align: center;
            }

            .wrapper {
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                -webkit-flex-flow: row wrap;
                -ms-flex-flow: row wrap;
                flex-flow: row wrap;
                -webkit-justify-content: flex-start;
                -ms-flex-pack: start;
                justify-content: flex-start;
            }

            .video {
                display: inline-block;
                -webkit-flex-basis: 30%;
                -ms-flex-preferred-size: 30%;
                flex-basis: 30%;
                margin: 1.666%;
                box-sizing: border-box;
                transition: maxHeight .5s ease;
                max-height: 1000px;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                -webkit-flex-flow: column nowrap;
                -ms-flex-flow: column nowrap;
                flex-flow: column nowrap;
                -webkit-justify-content: flex-start;
                -ms-flex-pack: start;
                justify-content: flex-start;
                -webkit-align-items: stretch;
                -ms-flex-align: stretch;
                align-items: stretch;
            }

            .video.selected {
                -webkit-flex-basis: 0;
                -ms-flex-preferred-size: 0;
                flex-basis: 0;
                overflow: hidden;
                border: none;
                margin: 0;
                font-size: 0;
                max-height: 0;
                opacity: 0;
            }

            .video.selected * {
                opacity: 0;
                transition: .4s linear;
            }

            .video .thumbnail {
                /* 16:9 ratio */
                padding-bottom: 56.25%;
                position: relative;
                background-size: cover;
                background-position: center center;
            }

            .video .thumbnail .overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, .2);
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                -webkit-flex-flow: row wrap;
                -ms-flex-flow: row wrap;
                flex-flow: row wrap;
                -webkit-justify-content: center;
                -ms-flex-pack: center;
                justify-content: center;
                -webkit-align-items: center;
                -ms-flex-align: center;
                align-items: center;
                transition: .2s ease;
            }

            .video .thumbnail .overlay:hover {
                background: rgba(0, 0, 0, .5);
                transition: .2s ease;
                cursor: pointer;
            }

            .video .thumbnail .overlay a {
                color: white;
                text-decoration: none;
                padding: .75em 1.5em;
                display: inline-block;
                background: rgba(0, 0, 0, .8);
                font-size: 1em;
                transition: .2s ease;
                text-align: center;
                border-radius: .75em;
            }

            .video .thumbnail .overlay svg {
                width: 1em;
                height: 1em;
                margin: 0;
                display: block;
            }

            .video .thumbnail .overlay svg g {
                fill: white;
            }

            .video .thumbnail .overlay:hover a {
                /*padding: 1.5em 2.1em;*/
                background: #cc181e;
                /* from youtube */
                transition: .2s ease;
            }

            .video .embed-container {
                position: relative;
                padding-bottom: 56.25%;
                height: 0;
                overflow: hidden;
                width: 100%;
                margin: 0 auto
            }

            .embed-container embed,
            .embed-container iframe,
            .embed-container object {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%
            }

            .details {
                padding: 1em;
                text-align: center;
                -webkit-flex: 1 0 auto;
                -ms-flex: 1 0 auto;
                flex: 1 0 auto;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                -webkit-flex-flow: column nowrap;
                -ms-flex-flow: column nowrap;
                flex-flow: column nowrap;
                -webkit-align-items: stretch;
                -ms-flex-align: stretch;
                align-items: stretch;
                -webkit-justify-content: space-between;
                -ms-flex-pack: justify;
                justify-content: space-between;
            }

            .details h3 {
                text-align: left;
                margin: .5em 0;
            }

            .details marked-element ::content {
                text-align: left;
                -webkit-flex-grow: 2;
                -ms-flex-positive: 2;
                flex-grow: 2;
            }

            .details a.button {
                text-transform: uppercase;
                text-decoration: none;
                background: #c30;
                padding: 1em 2em;
                display: inline-block;
                color: white;
                font-weight: bold;
                transition: .2s ease;
                -webkit-align-self: center;
                -ms-flex-item-align: center;
                align-self: center;
            }

            .details a.button:hover {
                background: #a52900;
                transition: .2s ease;
            }

            @media screen and (max-width: 991px) {
                .video {
                    -webkit-flex-basis: auto;
                    -ms-flex-preferred-size: auto;
                    flex-basis: auto;
                    width: 40%;
                    margin: 5%;
                }
            }

            @media screen and (max-width: 599px) {
                .video {
                    -webkit-flex-basis: 90%;
                    -ms-flex-preferred-size: 90%;
                    flex-basis: 90%;
                }
                .video .details marked-element {
                    display: none;
                }
            }
        </style>
        <content></content>


            <iron-selector class="wrapper" attr-for-selected="name" selected$="[[select]]" selected-item="{{selectedItem}}" selected-class="selected" fallback-selection$="[[videos.0.slug]]" on-iron-activate="handleIronSelectorActivate">

            <template is="dom-repeat" items="[[videos]]" id="videoList" filter="_hasContent">

                <epic-card placeholder="https://images.contentful.com/1kzutnf7jc3r/3NuGgGWb2ggSo0Ks06QISc/2115b37977a817a28cfb65aed3633c43/ecRidesWithZeal.jpeg?w=1"
                           elevation="1"
                           image="[[item.thumbnail]]"
                           name$="[[item.slug]]"
                           heading="[[item.title]]"
                           href="[[item.slug]]"
                           type="video"
                           fade-image
                           preload-image>
                        <div class="content">
                          <marked-element markdown="[[item.description]]"></marked-element>
                        </div>
                        <div class="actions">
                          <epic-button expand href="[[item.slug]]"  on-tap="handleClick">Watch Now</epic-button>
                        </div>
                </epic-card>



                <!-- <div class="video videoCard" name$="[[item.slug]]">
                    <a href="[[item.slug]]" class="thumb-link" on-click="handleClick">
                        <div class="thumbnail" style$="background-image: url([[item.thumbnail]])">
                        <div class="overlay">
                                <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 72 72" style="enable-background:new 0 0 72 72;" alt="play video">
                                    <g>
                                        <polygon points="0,0 72,36 0,72" />
                                    </g>
                                </svg>
                        </div>
                    </div>
                    </a>
                    <div class="details">
                        <h3>[[item.title]]</h3>
                        <marked-element markdown="[[item.description]]"></marked-element>
                        <a href="[[item.slug]]" class="button" on-click="handleClick">Watch Now</a>
                    </div>
                </div> -->
            </template>
            </iron-selector>
    </template>

    <script>
        /*
          Polymer <epic-video-grid>
          Github: https://github.com/epic-elements/epic-video-grid
          Author: Alex Goodwin (https://github.com/AlexGoodwin)

          NOTE: There is a bug in IE when a user clicks on the SVG play arrow for videos, it doesn't work. This is due to an IE bug where SVG elements don't support element.classList. Since IE usage is so low, I'm leaving this and moving on.

          NOTE: Dynamic Vimeo thumbnails are currently supported. For now, a URL to a blue 480x360px image with "Vimeo" text is returned.

          TODO: fix vimeo thumbnail support
        */
        Polymer({
            is: 'epic-video-grid',

            properties: {
                /**
                  An array of video objects, where each object makes up a card in the video grid
                */
                videos: {
                    type: Array,
                    notify: true,
                    value: function() {
                        return [];
                    }
                },

                select:{
                    type:String,
                    notify:true,
                    value: ''
                },

                selected:{
                    type:String,
                    notify:true,
                    readOnly: true,
                    computed: '_computeSelected(selectedItem)'
                }
            },

            observers: [
                '_observeVideoChanges(videos)',
                '_observeSelectedItemChanges(select, videos.*)',
            ],

            handleClick: function(e, detail) {
                this.fire('item-click');
            },

            handleIronSelectorActivate: function(e, detail) {

            },

            _observeSelectedItemChanges: function(select, videoChanges){

                if(videoChanges.base.length > 0 && !select){
                    this.select = videoChanges.base[0].slug;
                } else {
                    this.select = select;
                }
            },

            _computeSelected(selectedItem) {
                if(selectedItem) {
                    return selectedItem.getAttribute('name');
                }
            },

            _observeVideoChanges: function(videos) {
                videos.forEach((function(video, index){
                        this.set('videos.' + index + '.thumbnail', this.getThumbnailUrl(video.embedUrl, index));
                }).bind(this));
            },

            _hasContent: function(item) {
                        if(item.embedUrl){
                                    return item;
                        }

            },

            /**
              Returns the URL of the thumbnail image to use for the video
              Note vimeo returns a default for now (//placehold.it/480x360/1ab7ea/ffffff/?text=Vimeo)
            */
            getThumbnailUrl: function(embedUrl, videoNumber) {
                if (embedUrl) {

                    var thumbnailUrl = '',
                        videoId = '';

                    if (embedUrl.indexOf('youtube.com') !== -1) {
                        // get [1] in match() array because we want the second captured group (the video id)
                        videoId = embedUrl.match(/(?:.?|)youtube\.com\/(?:embed\/|watch\?v\=)([^\?\v$^]+)/i)[1];
                        thumbnailUrl = '//img.youtube.com/vi/' + videoId + '/hqdefault.jpg';
                        return thumbnailUrl;

                    } else if (embedUrl.indexOf('vimeo.com') !== -1) {

                        /************************

                        There's currently an issue with rendering thumbnail updates for vimeo. Putting this issue on the backburner for now.

                        videoId = embedUrl.match(/(?:.?|)vimeo\.com\/(?:video\/|watch\?v\=)([^\?\v$^]+)/i)[1];

                        var jsonUrl = "http://vimeo.com/api/v2/video/" + videoId + ".json";

                        var xmlhttp = new XMLHttpRequest();
                        xmlhttp.open('GET', jsonUrl, true);
                        xmlhttp.onreadystatechange = (function() {
                            if (xmlhttp.readyState == 4) {
                                if (xmlhttp.status == 200) {
                                    this.videos[videoNumber].thumbnail = JSON.parse(xmlhttp.responseText)[0].thumbnail_large;
                                }
                            }
                        }).bind(this);
                        xmlhttp.send(null);

                        ************************/

                        // return a placeholder for now until proper vimeo support
                        return '//placehold.it/480x360/1ab7ea/ffffff/?text=Vimeo';

                    } else {
                        console.error('video thumbnail generation failed; possibly malformed video url? only youtube and vimeo are currently supported');
                    }

                } else {
                    return '';
                }
            },

            ready: function() {},
        });
    </script>
</dom-module>
